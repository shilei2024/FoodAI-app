# AI轻食记 - 扩展功能部署指南

## 📋 部署前准备

### 1. 环境要求
- 微信开发者工具（最新版本）
- Node.js 14+ 环境
- 微信小程序云开发环境
- 百度AI开放平台账号（可选，用于AI识别）

### 2. 云开发配置
1. 在微信公众平台创建小程序
2. 开通云开发功能
3. 获取云环境ID
4. 设置云函数白名单

## 🚀 部署步骤

### 步骤1：配置云环境
```javascript
// 修改 miniprogram/app.js 中的云环境配置
wx.cloud.init({
  env: 'your-cloud-env-id', // 替换为你的云环境ID
  traceUser: true
})
```

### 步骤2：创建数据库集合
在云开发控制台创建以下集合：
```
1. users           - 用户信息
2. user_stats      - 用户统计
3. user_usage      - 用户使用记录
4. vip_orders      - VIP订单
5. share_records   - 分享记录
6. reward_logs     - 奖励日志
7. vip_benefits    - VIP权益记录
8. baidu_ai_cache  - AI服务缓存
```

### 步骤3：部署云函数
```bash
# 进入项目根目录
cd FoodAI-app

# 部署用户认证云函数
cd cloudfunctions/user-auth
npm install
# 在微信开发者工具中右键上传云函数

# 部署VIP管理云函数
cd ../vip-manager
npm install
# 上传云函数

# 部署分享奖励云函数
cd ../share-reward
npm install
# 上传云函数

# 部署现有云函数（如果存在）
cd ../baidu-ai
npm install
# 上传云函数
```

### 步骤4：配置环境变量
在云开发控制台设置环境变量：
```
BAIDU_AI_API_KEY=你的百度AI API Key
BAIDU_AI_SECRET_KEY=你的百度AI Secret Key
DEEPSEEK_API_KEY=你的Deepseek API Key（可选）
```

### 步骤5：前端配置更新
```javascript
// 更新 miniprogram/constants/config.js
const config = {
  // ... 现有配置 ...
  
  // 新增云开发配置
  cloud: {
    env: 'your-cloud-env-id',
    traceUser: true
  },
  
  // 启用扩展功能
  features: {
    wechatLogin: true,      // 微信登录
    cloudSync: true,        // 云端同步
    vipSystem: true,        // VIP系统
    shareReward: true,      // 分享奖励
    analytics: true,        // 数据分析
    secureMode: true        // 安全模式（使用云函数）
  },
  
  // VIP套餐价格配置
  payment: {
    plans: {
      monthly: 29,    // 月卡29元
      quarterly: 69,  // 季卡69元
      yearly: 199,    // 年卡199元
      lifetime: 599   // 永久会员599元
    }
  },
  
  // 分享奖励配置
  shareReward: {
    dailyLimit: 5,          // 每日最多奖励次数
    rewardPoints: 10,       // 每次分享奖励积分
    extraPhotoCount: 1,     // 每次分享额外拍照次数
    extraSearchCount: 2,    // 每次分享额外搜索次数
    firstShareBonus: 50,    // 首次分享额外奖励
    inviteReward: 100       // 邀请新用户奖励
  }
}
```

## 🔧 功能开关控制

### 1. 渐进式启用
```javascript
// 可以根据需要逐步启用功能
const featureFlags = {
  // 第一阶段：基础功能
  stage1: {
    wechatLogin: true,
    cloudSync: false,  // 先使用本地存储
    vipSystem: false,
    shareReward: false
  },
  
  // 第二阶段：增值功能
  stage2: {
    wechatLogin: true,
    cloudSync: true,   // 启用云端同步
    vipSystem: true,   // 启用VIP系统
    shareReward: false
  },
  
  // 第三阶段：完整功能
  stage3: {
    wechatLogin: true,
    cloudSync: true,
    vipSystem: true,
    shareReward: true  // 启用分享奖励
  }
}
```

### 2. A/B测试配置
```javascript
// 可以对不同用户群体启用不同功能
const abTesting = {
  groupA: {  // 对照组
    vipPrice: 29,
    shareReward: false
  },
  groupB: {  // 实验组
    vipPrice: 19,  // 优惠价格
    shareReward: true
  }
}
```

## 🧪 测试验证

### 1. 单元测试
```bash
# 测试用户服务
# 可以添加测试文件进行验证
```

### 2. 集成测试
测试场景：
1. 新用户注册登录流程
2. VIP购买和使用流程
3. 分享奖励领取流程
4. 数据同步和恢复流程

### 3. 压力测试
- 并发用户登录测试
- 大数据量同步测试
- 支付回调压力测试

## 📊 监控和运维

### 1. 云开发监控
- 云函数调用次数和耗时
- 数据库读写性能
- 存储空间使用情况
- 错误日志监控

### 2. 业务指标监控
```javascript
const businessMetrics = {
  // 用户指标
  dailyActiveUsers: 0,
  newUserRegistrations: 0,
  userRetentionRate: 0,
  
  // 收入指标
  vipConversionRate: 0,
  averageRevenuePerUser: 0,
  monthlyRecurringRevenue: 0,
  
  // 增长指标
  shareInvitationRate: 0,
  viralCoefficient: 0,
  customerAcquisitionCost: 0
}
```

### 3. 告警设置
- 云函数错误率 > 5%
- 数据库响应时间 > 1000ms
- 支付失败率 > 2%
- 用户登录失败率 > 10%

## 🔄 数据迁移

### 1. 从本地到云端
```javascript
// 迁移脚本示例
async function migrateLocalToCloud() {
  // 1. 导出本地用户数据
  const localUsers = wx.getStorageSync('userInfo')
  
  // 2. 批量导入到云端
  for (const user of localUsers) {
    await wx.cloud.callFunction({
      name: 'user-auth',
      data: {
        action: 'migrateUser',
        userData: user
      }
    })
  }
  
  // 3. 验证数据一致性
  const cloudCount = await getCloudUserCount()
  const localCount = localUsers.length
  
  console.log(`迁移完成：本地${localCount}条，云端${cloudCount}条`)
}
```

### 2. 数据备份策略
- 每日自动备份
- 重要操作日志
- 用户数据导出功能
- 灾难恢复计划

## 🛡️ 安全配置

### 1. 权限控制
```javascript
// 数据库权限规则
{
  "users": {
    "read": "auth.openid == doc._openid",
    "write": "auth.openid == doc._openid"
  },
  "vip_orders": {
    "read": "auth.openid == doc.userId",
    "write": false  // 仅云函数可写
  }
}
```

### 2. 数据加密
- 敏感信息加密存储
- 传输数据HTTPS加密
- API密钥安全管理
- 支付信息PCI合规

### 3. 防作弊机制
- 分享次数限制
- 邀请关系验证
- 异常行为检测
- 机器人防护

## 📈 性能优化

### 1. 缓存策略
```javascript
// 多级缓存设计
const cacheStrategy = {
  level1: '内存缓存（5分钟）',
  level2: '本地存储缓存（1小时）',
  level3: 'CDN缓存（24小时）',
  level4: '数据库持久化'
}
```

### 2. 懒加载
- 用户信息按需加载
- 历史记录分页加载
- 图片延迟加载
- 组件动态导入

### 3. 代码优化
- 云函数冷启动优化
- 数据库查询优化
- 前端包体积优化
- 网络请求合并

## 🚨 故障处理

### 1. 常见问题解决
```
问题1：云函数调用失败
解决：检查网络连接，验证云环境配置

问题2：用户登录异常
解决：清除本地缓存，重新登录

问题3：数据同步冲突
解决：使用时间戳解决冲突，保留最新数据

问题4：支付回调失败
解决：检查支付配置，手动处理异常订单
```

### 2. 应急预案
- 云服务宕机：启用本地模式
- 数据库异常：切换到备份数据库
- 支付系统故障：启用维护模式
- 安全漏洞：立即暂停相关功能

## 📚 文档和培训

### 1. 开发文档
- API接口文档
- 数据库设计文档
- 部署流程文档
- 故障处理手册

### 2. 用户文档
- 功能使用指南
- VIP特权说明
- 分享奖励规则
- 隐私政策说明

### 3. 培训材料
- 新功能培训
- 运维操作培训
- 客户服务培训
- 销售话术培训

## 🎯 上线计划

### 阶段1：内测阶段（1-2周）
- 小范围用户测试
- 功能bug修复
- 性能优化调整

### 阶段2：公测阶段（2-4周）
- 扩大用户范围
- 收集用户反馈
- 优化用户体验

### 阶段3：正式上线
- 全量用户开放
- 市场推广启动
- 数据监控加强

### 阶段4：持续优化
- 根据数据优化
- 新增功能开发
- 商业模式探索

## 💡 最佳实践

1. **渐进式发布**：逐步开放功能，监控系统稳定性
2. **数据驱动**：基于用户数据优化产品功能
3. **用户反馈**：建立用户反馈渠道，快速响应问题
4. **安全第一**：定期安全审计，及时修复漏洞
5. **性能监控**：建立全面的性能监控体系
6. **备份策略**：定期备份数据，确保业务连续性

通过以上部署指南，您可以顺利地将扩展功能部署到生产环境，并为用户提供更完善的服务体验。
