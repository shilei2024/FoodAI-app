# AI轻食记 - 配置指南

本文档将指导您完成FoodAI小程序的完整配置，使其能够正常运行并提供真实的AI识别和营养分析功能。

## 目录
1. [快速开始](#快速开始)
2. [AI服务配置](#ai服务配置)
3. [支付功能配置](#支付功能配置)
4. [云函数部署](#云函数部署)
5. [常见问题](#常见问题)

---

## 快速开始

### 1. 环境准备
- 微信开发者工具（最新版本）
- Node.js 14+ 
- 微信小程序账号（已完成注册）

### 2. 项目初始化
```bash
# 克隆项目
git clone <your-repo-url>

# 进入项目目录
cd FoodAI

# 安装依赖
npm install
```

### 3. 基础配置
在 `miniprogram/constants/config.js` 中配置小程序AppID：
```javascript
payment: {
  wechatPay: {
    appId: 'wx38dee0ea03214271', // 替换为您的小程序AppID
    // ...
  }
}
```

---

## AI服务配置

### 方案一：Deepseek AI（推荐）

Deepseek提供高质量的AI服务，适合食物识别和营养分析。

#### 1. 获取API密钥

1. 访问 [Deepseek开放平台](https://platform.deepseek.com/)
2. 注册/登录账号
3. 进入控制台，创建API密钥
4. 复制生成的API Key（格式：`sk-xxxxxxxxxxxxxxxx`）

#### 2. 配置密钥

在 `miniprogram/constants/config.js` 中配置：

```javascript
deepseekAI: {
  apiKey: 'sk-your-actual-api-key-here', // 替换为您的Deepseek API Key
  baseURL: 'https://api.deepseek.com/v1',
  // ...
}
```

#### 3. 测试配置

1. 在微信开发者工具中打开项目
2. 进入首页，点击"测试Deepseek API"按钮（如有）
3. 或直接尝试搜索食物名称，查看是否返回真实数据

#### 4. 注意事项

⚠️ **重要安全提示**：
- API密钥会暴露在小程序代码中
- 建议生产环境使用云函数保护密钥
- 定期检查API使用量和费用
- 不要将密钥提交到公开的代码仓库

### 方案二：百度AI（备选）

如果您更倾向使用百度AI服务：

#### 1. 获取API密钥

1. 访问 [百度AI开放平台](https://ai.baidu.com/)
2. 注册/登录账号
3. 创建应用，选择"图像识别"服务
4. 获取API Key和Secret Key

#### 2. 配置密钥

在 `miniprogram/constants/config.js` 中配置：

```javascript
baiduAI: {
  apiKey: 'your-baidu-api-key',
  secretKey: 'your-baidu-secret-key',
  // ...
}
```

#### 3. 启用百度AI

在 `miniprogram/services/ai-service.js` 中：

```javascript
constructor() {
  // ...
  this.useDeepseekAPI = false; // 改为false以使用百度AI
  // ...
}
```

#### 4. 完善百度AI实现

当前百度AI识别功能需要进一步实现。参考百度AI文档：
- [菜品识别API文档](https://ai.baidu.com/ai-doc/IMAGERECOGNITION/Xk3bcxe9t)
- [通用物体识别API文档](https://ai.baidu.com/ai-doc/IMAGERECOGNITION/Xk3bcxe9t)

---

## 支付功能配置

支付功能需要微信支付商户号和云函数支持。

### 前置条件

- 小程序已完成企业认证（个人小程序无法开通支付）
- 已开通微信支付商户号
- 已完成商户号与小程序的关联

### 配置步骤

#### 1. 获取支付参数

登录 [微信支付商户平台](https://pay.weixin.qq.com/)，获取：
- 商户号（mchId）
- API密钥（apiKey）
- 证书文件（apiclient_cert.p12）

#### 2. 配置支付参数

在 `miniprogram/constants/config.js` 中配置：

```javascript
payment: {
  wechatPay: {
    appId: 'your-appid',
    mchId: 'your-mch-id',
    apiKey: 'your-api-key',
    notifyUrl: 'https://your-domain.com/payment-callback'
  },
  // ...
}
```

#### 3. 部署支付云函数

支付功能需要以下云函数：
- `create-order`：创建支付订单
- `payment-callback`：支付回调处理
- `get-payment-params`：获取支付参数（含签名）

详见 [云函数部署](#云函数部署) 章节。

#### 4. 测试支付流程

1. 在测试环境使用沙箱模式
2. 配置 `features.payment.testMode = true`
3. 使用测试账号进行支付测试

---

## 云函数部署

### 方案一：微信云开发（需企业认证）

#### 1. 开通云开发

1. 在微信开发者工具中，点击"云开发"
2. 开通云开发服务
3. 创建云环境，获取环境ID

#### 2. 配置环境ID

在 `miniprogram/constants/config.js` 中配置：

```javascript
cloud: {
  env: 'your-cloud-env-id', // 替换为您的云环境ID
  traceUser: true
}
```

#### 3. 部署云函数

```bash
# 在微信开发者工具中
# 右键 cloudfunctions 目录下的各个云函数
# 选择"上传并部署：云端安装依赖"

# 需要部署的云函数：
- baidu-ai          # 百度AI代理
- create-order      # 创建订单
- payment-callback  # 支付回调
- get-payment-params # 获取支付参数
```

#### 4. 配置云函数环境变量

在云开发控制台中，为每个云函数配置环境变量：

**baidu-ai 云函数：**
```
BAIDU_API_KEY=your-baidu-api-key
BAIDU_SECRET_KEY=your-baidu-secret-key
```

**支付相关云函数：**
```
MCH_ID=your-mch-id
API_KEY=your-api-key
```

### 方案二：腾讯云函数（个人认证可用）

如果您的小程序是个人认证，无法使用微信云开发，可以使用腾讯云函数。

#### 1. 注册腾讯云

1. 访问 [腾讯云](https://cloud.tencent.com/)
2. 注册并完成实名认证
3. 开通云函数服务

#### 2. 部署云函数

参考 `tencent-scf/` 目录下的云函数代码：

```bash
# 使用腾讯云CLI部署
cd tencent-scf/baidu-ai-proxy
scf deploy
```

#### 3. 配置API网关

1. 为云函数创建API网关触发器
2. 获取API网关地址
3. 在 `miniprogram/constants/config.js` 中配置：

```javascript
tencentSCF: {
  baseUrl: 'https://service-xxxxx-xxxxx.gz.apigw.tencentcs.com/release',
  timeout: 30000
}
```

#### 4. 配置云函数环境变量

在腾讯云函数控制台中配置环境变量（同微信云开发）。

---

## 数据库配置

### 初始化数据库

如果使用云开发，需要初始化数据库集合：

```bash
# 运行初始化脚本
node scripts/init-database.js
```

该脚本会创建以下集合：
- `recognition_records`：识别记录
- `users`：用户信息
- `orders`：订单记录
- `recipes`：食谱记录

### 数据库权限

在云开发控制台中，为每个集合配置合适的权限：
- `recognition_records`：仅创建者可读写
- `users`：仅创建者可读写
- `orders`：仅创建者可读写
- `recipes`：所有用户可读，仅创建者可写

---

## 常见问题

### Q1: 为什么搜索食物时显示"API密钥未配置"？

**A:** 您需要在 `miniprogram/constants/config.js` 中配置Deepseek或百度AI的API密钥。参考 [AI服务配置](#ai服务配置) 章节。

### Q2: 为什么支付功能无法使用？

**A:** 支付功能需要：
1. 小程序企业认证
2. 开通微信支付商户号
3. 配置支付参数
4. 部署支付云函数

个人小程序无法开通支付功能。

### Q3: 云函数调用失败怎么办？

**A:** 检查以下几点：
1. 云环境ID是否正确配置
2. 云函数是否已部署
3. 云函数环境变量是否已配置
4. 小程序是否已关联云环境

### Q4: 如何切换开发/生产环境？

**A:** 在 `miniprogram/constants/config.js` 中修改：

```javascript
function getEnvConfig() {
  const env = 'production' // 改为 'production' 或 'development'
  return envConfig[env] || envConfig.development
}
```

### Q5: API调用次数有限制吗？

**A:** 
- Deepseek API：根据您的套餐有不同的限制
- 百度AI：免费版有每日调用次数限制
- 建议在生产环境中添加调用频率限制和缓存机制

### Q6: 如何保护API密钥安全？

**A:** 
1. **最佳实践**：使用云函数，将API密钥配置在云函数环境变量中
2. 不要将密钥提交到公开的代码仓库
3. 定期更换API密钥
4. 监控API使用情况，及时发现异常

### Q7: 历史记录数据会丢失吗？

**A:** 
- 当前版本使用本地存储，换设备会丢失
- 配置云开发后，数据会自动同步到云端
- 建议定期导出数据备份

---

## 技术支持

如果您在配置过程中遇到问题：

1. 查看项目文档：`README.md`、`未完成功能.md`
2. 查看代码注释和错误提示
3. 查看相关服务的官方文档：
   - [Deepseek API文档](https://platform.deepseek.com/docs)
   - [百度AI文档](https://ai.baidu.com/docs)
   - [微信小程序文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
   - [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)

---

## 配置检查清单

完成配置后，请检查以下项目：

- [ ] 已配置小程序AppID
- [ ] 已配置AI服务API密钥（Deepseek或百度AI）
- [ ] AI识别功能正常工作
- [ ] 食物搜索功能正常工作
- [ ] 历史记录可以保存和查看
- [ ] （可选）已配置支付功能
- [ ] （可选）已部署云函数
- [ ] （可选）已配置云数据库

---

## 下一步

配置完成后，您可以：

1. 在开发者工具中预览和调试
2. 体验完整的AI识别和营养分析功能
3. 根据需求定制功能和UI
4. 提交小程序审核并发布

祝您使用愉快！🎉

